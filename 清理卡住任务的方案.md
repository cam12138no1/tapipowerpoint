# æ¸…ç†å¡ä½ä»»åŠ¡çš„æ–¹æ¡ˆ

## é—®é¢˜
1.29 çš„æ—§ä»»åŠ¡è¿˜åœ¨åˆ—è¡¨ä¸­æ˜¾ç¤ºä¸º "running" æˆ– "pending" çŠ¶æ€ï¼Œå®é™…ä¸Šå·²ç»å¡ä½äº†ã€‚

---

## æ–¹æ¡ˆ 1: æ·»åŠ è‡ªåŠ¨æ¸…ç†åŠŸèƒ½ï¼ˆæ¨èï¼‰â­

**åœ¨ä»£ç ä¸­æ·»åŠ è‡ªåŠ¨æ¸…ç†é€»è¾‘**ï¼Œå¯åŠ¨æ—¶æˆ–å®šæ—¶æ¸…ç†è¶…è¿‡ 24 å°æ—¶çš„å¡ä½ä»»åŠ¡ã€‚

### å®ç°ä»£ç 

åˆ›å»ºæ–‡ä»¶ `server/cleanup-tasks.ts`:

```typescript
import * as db from './db';

/**
 * æ¸…ç†è¶…è¿‡æŒ‡å®šæ—¶é—´çš„å¡ä½ä»»åŠ¡
 */
export async function cleanupStuckTasks(hoursOld: number = 24) {
  const cutoffDate = new Date(Date.now() - hoursOld * 60 * 60 * 1000);
  
  console.log(`[Cleanup] Checking for tasks stuck before ${cutoffDate.toISOString()}`);
  
  // æŸ¥æ‰¾å¡ä½çš„ä»»åŠ¡
  const stuckTasks = await db.getPptTasksByStatus(['running', 'pending', 'uploading', 'ask']);
  
  const tasksToCleanup = stuckTasks.filter(task => {
    return new Date(task.createdAt) < cutoffDate;
  });
  
  console.log(`[Cleanup] Found ${tasksToCleanup.length} stuck tasks to cleanup`);
  
  // æ ‡è®°ä¸ºå¤±è´¥
  for (const task of tasksToCleanup) {
    await db.updatePptTask(task.id, {
      status: 'failed',
      errorMessage: 'ä»»åŠ¡è¶…æ—¶ï¼ˆè¶…è¿‡ 24 å°æ—¶æœªå®Œæˆï¼‰',
      currentStep: 'ä»»åŠ¡å·²è¶…æ—¶',
    });
    await db.addTimelineEvent(task.id, 'ä»»åŠ¡è‡ªåŠ¨æ¸…ç†ï¼ˆè¶…æ—¶ï¼‰', 'failed');
    console.log(`[Cleanup] Marked task ${task.id} as failed`);
  }
  
  return tasksToCleanup.length;
}

// åœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶è¿è¡Œä¸€æ¬¡
export async function runStartupCleanup() {
  try {
    const count = await cleanupStuckTasks(24);
    console.log(`[Cleanup] Startup cleanup completed: ${count} tasks cleaned`);
  } catch (error) {
    console.error('[Cleanup] Startup cleanup failed:', error);
  }
}
```

### åœ¨å¯åŠ¨è„šæœ¬ä¸­è°ƒç”¨

åœ¨ `server/_core/index.ts` çš„å¯åŠ¨ä»£ç ä¸­æ·»åŠ ï¼š

```typescript
import { runStartupCleanup } from '../cleanup-tasks';

// åœ¨æœåŠ¡å™¨å¯åŠ¨åè¿è¡Œæ¸…ç†
app.listen(port, async () => {
  console.log(`Server running on http://localhost:${port}/`);
  
  // æ¸…ç†å¡ä½çš„ä»»åŠ¡
  await runStartupCleanup();
});
```

**ä¼˜ç‚¹**ï¼š
- âœ… è‡ªåŠ¨åŒ–ï¼Œä¸éœ€è¦æ‰‹åŠ¨æ“ä½œ
- âœ… æ¯æ¬¡é‡å¯éƒ½ä¼šæ¸…ç†
- âœ… å¯é…ç½®æ—¶é—´é˜ˆå€¼

---

## æ–¹æ¡ˆ 2: æ‰‹åŠ¨ SQL æ¸…ç†ï¼ˆå¿«é€Ÿï¼‰âš¡

**ç›´æ¥åœ¨ Render Postgres ä¸­æ‰§è¡Œ SQL**

### æ­¥éª¤

1. **Render Dashboard â†’ Database â†’ Shell**
2. æ‰§è¡ŒæŸ¥è¯¢ï¼š

```sql
-- 1. æŸ¥çœ‹å¡ä½çš„ä»»åŠ¡
SELECT id, title, status, created_at, updated_at, current_step
FROM ppt_tasks
WHERE status IN ('running', 'pending', 'uploading', 'ask')
  AND created_at < NOW() - INTERVAL '24 hours'
ORDER BY created_at DESC;

-- 2. ç¡®è®¤åï¼Œæ ‡è®°ä¸ºå¤±è´¥
UPDATE ppt_tasks
SET 
  status = 'failed',
  error_message = 'ä»»åŠ¡è¶…æ—¶ï¼ˆè¶…è¿‡ 24 å°æ—¶æœªå®Œæˆï¼‰',
  current_step = 'ä»»åŠ¡å·²è¶…æ—¶',
  updated_at = NOW()
WHERE status IN ('running', 'pending', 'uploading', 'ask')
  AND created_at < NOW() - INTERVAL '24 hours';

-- 3. æŸ¥çœ‹æ›´æ–°äº†å¤šå°‘æ¡
-- ä¼šæ˜¾ç¤º: UPDATE N (N æ˜¯æ›´æ–°çš„è¡Œæ•°)
```

**ä¼˜ç‚¹**ï¼š
- âœ… ç«‹å³ç”Ÿæ•ˆ
- âœ… ç®€å•ç›´æ¥
- âœ… å¯ä»¥ç²¾ç¡®æ§åˆ¶

**ç¼ºç‚¹**ï¼š
- âŒ éœ€è¦æ‰‹åŠ¨æ‰§è¡Œ
- âŒ æ¯æ¬¡éƒ½è¦è®°å¾—æ¸…ç†

---

## æ–¹æ¡ˆ 3: å‰ç«¯éšè—æ—§ä»»åŠ¡ï¼ˆä¸´æ—¶ï¼‰

**åœ¨å‰ç«¯è¿‡æ»¤æ‰è¶…è¿‡ 24 å°æ—¶çš„å¡ä½ä»»åŠ¡**

åœ¨ `client/src/pages/Tasks.tsx` æˆ–åˆ—è¡¨ç»„ä»¶ä¸­ï¼š

```typescript
const filteredTasks = tasks.filter(task => {
  // å¦‚æœæ˜¯æ´»è·ƒçŠ¶æ€ä½†è¶…è¿‡ 24 å°æ—¶ï¼Œè¿‡æ»¤æ‰
  if (['running', 'pending', 'uploading'].includes(task.status)) {
    const createdAt = new Date(task.createdAt);
    const hoursDiff = (Date.now() - createdAt.getTime()) / (1000 * 60 * 60);
    if (hoursDiff > 24) {
      return false; // éšè—å¡ä½çš„æ—§ä»»åŠ¡
    }
  }
  return true;
});
```

**ä¼˜ç‚¹**ï¼š
- âœ… å¿«é€Ÿå®ç°
- âœ… ä¸éœ€è¦æ”¹æ•°æ®åº“

**ç¼ºç‚¹**ï¼š
- âŒ æ²»æ ‡ä¸æ²»æœ¬ï¼ˆä»»åŠ¡è¿˜åœ¨æ•°æ®åº“é‡Œï¼‰
- âŒ æ¯ä¸ªé¡µé¢éƒ½è¦åŠ è¿‡æ»¤

---

## æ–¹æ¡ˆ 4: æ·»åŠ å®šæ—¶æ¸…ç†ä»»åŠ¡ï¼ˆæœ€å®Œå–„ï¼‰

**ä½¿ç”¨ Render Cron Job å®šæ—¶æ¸…ç†**

åˆ›å»ºæ–‡ä»¶ `scripts/cleanup-cron.ts`:

```typescript
import * as db from '../server/db';

async function main() {
  const cutoff = new Date(Date.now() - 24 * 60 * 60 * 1000);
  
  // æŸ¥æ‰¾å¡ä½çš„ä»»åŠ¡
  const tasks = await db.query(`
    SELECT id FROM ppt_tasks
    WHERE status IN ('running', 'pending', 'uploading', 'ask')
      AND created_at < $1
  `, [cutoff]);
  
  // æ ‡è®°ä¸ºå¤±è´¥
  for (const task of tasks) {
    await db.updatePptTask(task.id, {
      status: 'failed',
      errorMessage: 'ä»»åŠ¡è¶…æ—¶',
    });
  }
  
  console.log(`Cleaned up ${tasks.length} tasks`);
}

main().catch(console.error);
```

**åœ¨ Render åˆ›å»º Cron Job**:
- æ¯å¤©è¿è¡Œä¸€æ¬¡
- Schedule: `0 0 * * *` (æ¯å¤©åˆå¤œ)
- Command: `node dist/scripts/cleanup-cron.js`

**ä¼˜ç‚¹**ï¼š
- âœ… å®Œå…¨è‡ªåŠ¨åŒ–
- âœ… å®šæœŸæ¸…ç†
- âœ… ä¸å½±å“æ€§èƒ½

---

## ğŸ¯ æ¨èæ–¹æ¡ˆ

**ç«‹å³æ“ä½œ**ï¼šæ–¹æ¡ˆ 2ï¼ˆSQL æ¸…ç†ï¼‰  
**é•¿æœŸæ–¹æ¡ˆ**ï¼šæ–¹æ¡ˆ 1ï¼ˆå¯åŠ¨æ—¶æ¸…ç†ï¼‰+ æ–¹æ¡ˆ 4ï¼ˆå®šæ—¶æ¸…ç†ï¼‰

---

## âš¡ å¿«é€Ÿæ“ä½œï¼ˆSQLï¼‰

**å¤åˆ¶ä»¥ä¸‹ SQLï¼Œåœ¨ Render Database Shell æ‰§è¡Œ**ï¼š

```sql
-- æŸ¥çœ‹æœ‰å¤šå°‘å¡ä½çš„ä»»åŠ¡
SELECT 
  COUNT(*) as stuck_count,
  status
FROM ppt_tasks
WHERE status IN ('running', 'pending', 'uploading', 'ask')
  AND created_at < NOW() - INTERVAL '24 hours'
GROUP BY status;

-- å¦‚æœç¡®è®¤è¦æ¸…ç†ï¼Œæ‰§è¡Œï¼š
UPDATE ppt_tasks
SET 
  status = 'failed',
  error_message = 'ä»»åŠ¡è¶…æ—¶ï¼ˆå·²è‡ªåŠ¨æ¸…ç†ï¼‰',
  current_step = 'ä»»åŠ¡å·²è¶…æ—¶',
  updated_at = NOW()
WHERE status IN ('running', 'pending', 'uploading', 'ask')
  AND created_at < NOW() - INTERVAL '24 hours';
```

---

## ğŸ”§ æˆ‘éœ€è¦åšä»€ä¹ˆï¼Ÿ

**è¯·å‘Šè¯‰æˆ‘æ‚¨æƒ³ç”¨å“ªä¸ªæ–¹æ¡ˆ**ï¼š

**A**: æˆ‘å…ˆæ‰‹åŠ¨ SQL æ¸…ç†ï¼ˆ5 åˆ†é’Ÿï¼‰  
**B**: å¸®æˆ‘æ·»åŠ è‡ªåŠ¨æ¸…ç†ä»£ç ï¼ˆ15 åˆ†é’Ÿï¼‰  
**C**: ä¸¤ä¸ªéƒ½åšï¼ˆå…ˆ SQL æ¸…ç†ï¼Œå†åŠ ä»£ç ï¼‰

**æˆ–è€…å‘Šè¯‰æˆ‘æ•°æ®åº“çš„è®¿é—®ä¿¡æ¯ï¼Œæˆ‘å¸®æ‚¨æ‰§è¡Œ SQLï¼**
